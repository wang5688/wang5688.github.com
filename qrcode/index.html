<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="./js/zepto.min.js"></script>
    <scrip src="./js/qrcode.lib.min.js"></scrip>
    <script src="./js/qrcode.js"></script>
    <style>
        input[node-type=jsbridge]{
            visibility: hidden;
        }
        .qr-btn{
            width: 100px;
            height: 40px;
            border: 1px solid #000;
            border-radius: 20px;
            line-height: 40px;
            text-align: center;
            background: rgb(61, 141, 214);
            color: #fff;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="qr-btn" node-type="jsbridge">扫描二维码
        <input type="file" node-type="jsbridge" name="myPhoto" value="扫描二维码">
    </div>
</body>
<script>
    // 初始化二维码按钮
    Qrcode.init($('[node-type=jsbridge]'));

    // 主要代码
    (function(){
        // 微博下解析
        var Qrcode = function(tempBtn){
            var _this = this;
            var isWeiboWebView = /__webo__/.test(navigator.userAgent);

            if(isWeiboWebView){
                if(window.WeiboJSBridge){
                    _this.bridgeReady(tempBtn);
                }else{
                    document.addEventListener('WeiboJSBridgeReady', function(){
                        _this.bridgeReady(tempBtn);
                    });
                }
            }else{
                _this.nativeReady(tempBtn);
            }
        }

        Qrcode.prototype = {
            WeiBoBridge : function(){
                WeiboJSBridge.involke('scanQRCode', null, function(params){
                    // 得到扫码结果
                    location.href = params.result;
                });
            },

            getImgFile : function(){
                var _this = this;
                var imgFile = $(this)[0].files;
                var oFile = imgFile[0];
                var oFReader = new Reader();
                var rFilter = /^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;

                if(imgFile.length === 0){
                    return;
                }

                if(!rFilter.test(oFile.type)){
                    alert('选择正确的图片格式');
                    return;
                }
                // 读取图片成功后执行的代码
                oFReader.onload = function(e){
                    qrcode.decode(e.target.result);
                    qrcode.callback = function(data){
                        // 得到扫码结果
                        location.href = data;
                    }
                };

                oFReader.readAsDataURL(oFile);
            },

            destory : function(){
                $(tempBtn).off('click');
            }
        };

        // 初始化
        Qrcode.init = function(tempBtn){
            var _this = this;
            var inputDom;
            tempBtn.each(function(){
                new _this($(this));
            });

            $('[node-type=jsbridge]').on('click', function(){
                $(this).find('[node-type=jsbridge]')[0].click();
            });
        }

        window.Qrcode = Qrcode;
    })(window.Zepto ? Zepto : jQuery);
</script>
</html>
